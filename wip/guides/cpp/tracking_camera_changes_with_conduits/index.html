<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Tracking Camera Changes with Conduits</title>
  <meta name="description" content="Tracking Camera Changes with Conduits">

  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/github.min.css">
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/languages/vbnet.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <!-- Overridden theme -->
  <link rel="stylesheet" href="/developer-rhino3d-com-branches/css/main.css">

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
  <!-- Bootstrap override -->
  <link rel="stylesheet" href="/developer-rhino3d-com-branches/css/bootstrap-override.css">

  <link rel="canonical" href="http://mcneel.github.io/developer-rhino3d-com-branches/developer-rhino3d-com-branches/guides/cpp/tracking_camera_changes_with_conduits/">
  <link rel="alternate" type="application/rss+xml" title="Rhino Developer Docs" href="http://mcneel.github.io/developer-rhino3d-com-branches/developer-rhino3d-com-branches/feed.xml" />

  <link rel="shortcut icon" href="http://developer.rhino3d.com/favicon.ico?v=2" />
  <!-- Saving bookmarks to mobile devices -->
  <!-- For non-Retina (@1× display) iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="/developer-rhino3d-com-branches/images/apple-touch-icon-precomposed.png"><!-- 57×57px -->
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/developer-rhino3d-com-branches/images/apple-touch-icon-72x72-precomposed.png">
  <!-- For the iPad mini and the first- and second-generation iPad (@1× display) on iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/developer-rhino3d-com-branches/images/apple-touch-icon-76x76-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/developer-rhino3d-com-branches/images/apple-touch-icon-114x114-precomposed.png">
  <!-- For iPhone with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/developer-rhino3d-com-branches/images/apple-touch-icon-120x120-precomposed.png">
  <!-- For iPad with @2× display running iOS ≤ 6: -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/developer-rhino3d-com-branches/images/apple-touch-icon-144x144-precomposed.png">
  <!-- For iPad with @2× display running iOS ≥ 7: -->
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/developer-rhino3d-com-branches/images/apple-touch-icon-152x152-precomposed.png">
  <!-- For iPhone 6 Plus with @3× display: -->
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/developer-rhino3d-com-branches/images/apple-touch-icon-180x180-precomposed.png">
  <!-- For Chrome for Android: -->
  <link rel="icon" sizes="192x192" href="images/touch-icon-192x192.png">

</head>


  <body>

    <!-- Google Tag Manager **This belongs right after the <body> tag**-->
    <noscript>
        <iframe src="//www.googletagmanager.com/ns.html?id=GTM-MWMDKN"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
        (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-MWMDKN');
    </script>
    <!-- End Google Tag Manager -->


    <div class="container">
      <header class="site-header">


    <a class="site-title" href="/developer-rhino3d-com-branches/"><img src="/developer-rhino3d-com-branches/images/rhinodevlogo148x128.png" alt="Rhino Developer Docs" height="48" width="56"></a><a class="site-title" href="/developer-rhino3d-com-branches/">Rhino Developer Docs</a>

    <nav class="site-nav">
      <img class="menu-icon" src="/developer-rhino3d-com-branches/images/gi.svg">
      
      <div class="trigger">
      	<!--<a class="page-link" href="/developer-rhino3d-com-branches/">Welcome</a>-->
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
            
              
            
          
        
          
        
          
            
              
                <a class="page-link" href="/developer-rhino3d-com-branches/guides/">Guides</a>
              
            
          
        
          
            
              
                <a class="page-link" href="/developer-rhino3d-com-branches/api/">API</a>
              
            
          
        
          
            
              
                <a class="page-link" href="/developer-rhino3d-com-branches/samples/">Samples</a>
              
            
          
        
          
            
          
        
        <a class="page-link" href="http://discourse.mcneel.com/c/rhino-developer">Forums</a>
        <!-- Google Search Engine -->
        <!-- TODO Move to this site back into the Mcneel search, or use a simple site only search for results -->
        <div id="sitesearch">
            <!-- Google CSE Search Box Begins  -->
            <!-- Use of this code assumes agreement with the Google Custom Search Terms of Service. -->
            <!-- The terms of service are available at https://www.google.com/cse/docs/tos.html -->
            <form id="cref" action="/developer-rhino3d-com-branches/search-results.html">
                <input type="hidden" name="cref" value="007988927381198593803:mcq6pshqsn8" />
                <input id="searchtext" type="text" name="q" size="24" value="" placeholder="search" />
                <input class="searchBox" type="submit" name="sa" size="2" value=" " />
            </form>
        <!-- Google CSE Search Box Ends -->
        </div>
        <!--End of Google Search Engine -->
      </div>
    </nav>

</header>


      <div class="page-content">
        
<div class="alert alert-danger" role="alert">
  Hey, you're viewing the <strong>wip</strong> version of the site!
  Click <a href="/guides/cpp/tracking_camera_changes_with_conduits/">here</a> to view the stable version of this page.
</div>


        <!--div class="wrapper"-->
          <div class="container-fluid">

<div class="row-fluid">
    <!--Nav Bar -->
    <nav class="col-xs-0 col-md-3 bs-docs-sidebar">
        <ul id="sidebar" class="nav nav-stacked fixed">

          <li>
            <a href="/developer-rhino3d-com-branches/guides/">Guides</a>

            <ul class="nav nav-stacked">

              <li>

                
                  <a href="/developer-rhino3d-com-branches/guides/#cpp">C/C++</a>
                
                <ul class="nav nav-stacked">

                  <!-- Find the h1 handle for title -->
                  
                  
                  
                  
                  
                  
                  
                  <li>
                    <a href="#tracking-camera-changes-with-conduits">Tracking Camera Changes w...</a>

                    <ul class="nav nav-stacked">

                      <!-- Find the h2 group and any h3 subgroups -->
                      

                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#problem">Problem</a>

                          

                        </li>
                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#solution">Solution</a>

                          

                        </li>
                      
                        
                        
                        
                        
                        
                        <li>
                          <a href="#sample">Sample</a>

                          

                        </li>
                      

                    </ul>

                  </li>

                </ul>

              </li>

            </ul>

          </li>

        </ul>
    </nav>
    <!--Main Content -->
    <div class="col-xs-12 col-md-9">
      <!--<div class="post">-->

        <article class="post-content">
          <h1 id="tracking-camera-changes-with-conduits">Tracking Camera Changes with Conduits</h1>

<p>This guide demonstrates how to use a conduit that uses notifiers to track camera information using C/C++.</p>

<h2 id="problem">Problem</h2>

<p>How can you get a windows message from Rhino viewport, specifically when rotating some object in viewport with right click?  The goal is to get the parameters from the camera viewport when there is an event, like mouse move or right click.  You need those camera settings parameters so that you can set them in another view.</p>

<h2 id="solution">Solution</h2>

<p>This can be done through what is called a Conduit Notification.  Basically, you setup a <code class="highlighter-rouge">CRhinoDisplayConduit</code>, attach it to a specific viewport (or all), and then “listen” for specific notifications by overriding <code class="highlighter-rouge">CRhinoDisplayConduit::NotifyConduit</code>.  You would most likely be interested in <code class="highlighter-rouge">CN_PIPELINEOPENED</code>, <code class="highlighter-rouge">CN_PIPELINECLOSED</code>, and <code class="highlighter-rouge">CN_PROJECTIONCHANGED</code> events.  On those events you can query the current viewport (camera) for any settings you want, and then react accordingly.</p>

<h2 id="sample">Sample</h2>

<p>The following sample plugin command demonstrates a conduit that uses notifiers to track camera information.  It also demonstrates how to create a HUD (Heads Up Display) used to display the tracked results and overlay them onto the viewport using transparent bitmap drawing.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include "stdafx.h"
</span>
<span class="c1">////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////
//
// BEGIN TestCameraTracker command
//
</span><span class="k">class</span> <span class="nc">CCameraTrackingConduit</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CRhinoDisplayConduit</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
              <span class="n">CCameraTrackingConduit</span><span class="p">();</span>

  <span class="n">bool</span>        <span class="n">ExecConduit</span><span class="p">(</span>
                  <span class="n">CRhinoDisplayPipeline</span><span class="o">&amp;</span><span class="p">,</span> <span class="c1">// pipeline executing this conduit
</span>                  <span class="n">UINT</span><span class="p">,</span>                   <span class="c1">// current channel within the pipeline
</span>                  <span class="n">bool</span><span class="o">&amp;</span>                   <span class="c1">// channel termination flag
</span>                  <span class="p">);</span>  

  <span class="kt">void</span>        <span class="n">NotifyConduit</span><span class="p">(</span><span class="n">EConduitNotifiers</span><span class="p">,</span> <span class="n">CRhinoDisplayPipeline</span><span class="o">&amp;</span><span class="p">);</span>

<span class="k">public</span><span class="o">:</span>
  <span class="kt">void</span>        <span class="n">StartTracking</span><span class="p">(</span><span class="k">const</span> <span class="n">CRhinoView</span><span class="o">*</span><span class="p">);</span>
  <span class="kt">void</span>        <span class="n">StopTracking</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="c1">// Conduit specific attributes...
</span><span class="nl">public:</span>
  <span class="n">ON_3dPoint</span>    <span class="n">m_CameraLocation</span><span class="p">;</span>
  <span class="n">ON_3dVector</span>   <span class="n">m_CameraDirection</span><span class="p">;</span>
  <span class="n">ON_3dPoint</span>    <span class="n">m_CameraTarget</span><span class="p">;</span>
  <span class="kt">double</span>        <span class="n">m_CameraLensLength</span><span class="p">;</span>
  <span class="kt">double</span>        <span class="n">m_CameraNear</span><span class="p">;</span>
  <span class="kt">double</span>        <span class="n">m_CameraFar</span><span class="p">;</span>

  <span class="c1">// TODO: Place more tracking variables here based on what you want to track...
</span>
<span class="k">private</span><span class="o">:</span>
  <span class="k">static</span> <span class="k">const</span> <span class="n">COLORREF</span> <span class="n">m_TransColor</span> <span class="o">=</span> <span class="n">RGB</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">);</span>

  <span class="n">CRhinoUiDib</span>   <span class="n">m_HUD</span><span class="p">;</span>

  <span class="kt">void</span> <span class="n">CreateHUD</span><span class="p">(</span><span class="k">const</span> <span class="n">CRhinoDisplayPipeline</span><span class="o">*</span><span class="p">);</span>
  <span class="n">bool</span> <span class="n">BuildHUD</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="p">};</span>

<span class="c1">/////////////////////////////////////////////////////////////////////////////
//
</span><span class="n">CCameraTrackingConduit</span><span class="o">::</span><span class="n">CCameraTrackingConduit</span><span class="p">()</span>

 <span class="o">:</span> <span class="n">CRhinoDisplayConduit</span><span class="p">(</span> <span class="n">CSupportChannels</span><span class="o">::</span><span class="n">SC_CALCBOUNDINGBOX</span> <span class="o">|</span>
                         <span class="n">CSupportChannels</span><span class="o">::</span><span class="n">SC_POSTPROCESSFRAMEBUFFER</span> <span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////////////////////////////
//
</span><span class="kt">void</span> <span class="n">CCameraTrackingConduit</span><span class="o">::</span><span class="n">CreateHUD</span><span class="p">(</span><span class="k">const</span> <span class="n">CRhinoDisplayPipeline</span><span class="o">*</span> <span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">dp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">CSize</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">GetFrameSize</span><span class="p">();</span>

    <span class="n">m_HUD</span><span class="p">.</span><span class="n">CreateDib</span><span class="p">(</span> <span class="n">fs</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span> <span class="n">fs</span><span class="p">.</span><span class="n">cy</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="nb">true</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////////////////////////////
//
</span><span class="n">bool</span> <span class="n">CCameraTrackingConduit</span><span class="o">::</span><span class="n">BuildHUD</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">LPBYTE</span>    <span class="n">HudBits</span> <span class="o">=</span> <span class="n">m_HUD</span><span class="p">.</span><span class="n">FindDIBBits</span><span class="p">();</span>
  <span class="n">bool</span>      <span class="n">success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">HudBits</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">CDC</span><span class="o">*</span>  <span class="n">pDC</span> <span class="o">=</span> <span class="n">m_HUD</span><span class="p">;</span> <span class="c1">// Our HUD is both a bitmap and a GDI device context,
</span>                       <span class="c1">// so we can use GDI routines to draw to it (ie. Text operations)
</span>
    <span class="c1">// Fill entire HUD with transparent color...we only want what we're about
</span>    <span class="c1">// to write into the HUD to show up...everything else is transparent so that
</span>    <span class="c1">// we can just overlay it onto the frame buffer...hence, it's a HUD (Heads Up Display)
</span>    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">FillSolidRect</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_HUD</span><span class="p">.</span><span class="n">Width</span><span class="p">(),</span> <span class="n">m_HUD</span><span class="p">.</span><span class="n">Height</span><span class="p">(),</span> <span class="n">m_TransColor</span> <span class="p">);</span>

    <span class="n">ON_wString</span>    <span class="n">text</span><span class="p">;</span>
    <span class="n">CSize</span>         <span class="n">exts</span><span class="p">;</span>
    <span class="kt">int</span>           <span class="n">nW</span> <span class="o">=</span> <span class="n">m_HUD</span><span class="p">.</span><span class="n">Width</span><span class="p">();</span>
    <span class="kt">int</span>           <span class="n">nH</span> <span class="o">=</span> <span class="n">m_HUD</span><span class="p">.</span><span class="n">Height</span><span class="p">();</span>

    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">SetTextColor</span><span class="p">(</span> <span class="n">RGB</span><span class="p">(</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>
    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">SetBkMode</span><span class="p">(</span> <span class="n">TRANSPARENT</span> <span class="p">);</span>

    <span class="n">text</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span> <span class="s">"Camera Location: %5.3f, %5.3f, %5.3f"</span><span class="p">,</span> <span class="n">m_CameraLocation</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">m_CameraLocation</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">m_CameraLocation</span><span class="p">.</span><span class="n">z</span> <span class="p">);</span>
    <span class="n">exts</span> <span class="o">=</span> <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">GetTextExtent</span><span class="p">(</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">TextOut</span><span class="p">(</span> <span class="n">nW</span> <span class="o">-</span> <span class="n">exts</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">exts</span><span class="p">.</span><span class="n">cy</span><span class="p">,</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>

    <span class="n">text</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span> <span class="s">"Camera Direction: %5.3f, %5.3f, %5.3f"</span><span class="p">,</span> <span class="n">m_CameraDirection</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">m_CameraDirection</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">m_CameraDirection</span><span class="p">.</span><span class="n">z</span> <span class="p">);</span>
    <span class="n">exts</span> <span class="o">=</span> <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">GetTextExtent</span><span class="p">(</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">TextOut</span><span class="p">(</span> <span class="n">nW</span> <span class="o">-</span> <span class="n">exts</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">exts</span><span class="p">.</span><span class="n">cy</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>

    <span class="n">text</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span> <span class="s">"Camera Target: %5.3f, %5.3f, %5.3f"</span><span class="p">,</span> <span class="n">m_CameraTarget</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">m_CameraTarget</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">m_CameraTarget</span><span class="p">.</span><span class="n">z</span> <span class="p">);</span>
    <span class="n">exts</span> <span class="o">=</span> <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">GetTextExtent</span><span class="p">(</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">TextOut</span><span class="p">(</span> <span class="n">nW</span> <span class="o">-</span> <span class="n">exts</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">exts</span><span class="p">.</span><span class="n">cy</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>

    <span class="n">text</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span> <span class="s">"Lens Length: %5.3f"</span><span class="p">,</span> <span class="n">m_CameraLensLength</span> <span class="p">);</span>
    <span class="n">exts</span> <span class="o">=</span> <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">GetTextExtent</span><span class="p">(</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">TextOut</span><span class="p">(</span> <span class="n">nW</span> <span class="o">-</span> <span class="n">exts</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">exts</span><span class="p">.</span><span class="n">cy</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>

    <span class="n">text</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span> <span class="s">"Camera Near &amp; Far: %5.3f, %5.3f"</span><span class="p">,</span><span class="n">m_CameraNear</span><span class="p">,</span> <span class="n">m_CameraFar</span> <span class="p">);</span>
    <span class="n">exts</span> <span class="o">=</span> <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">GetTextExtent</span><span class="p">(</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">pDC</span><span class="o">-&gt;</span><span class="n">TextOut</span><span class="p">(</span> <span class="n">nW</span> <span class="o">-</span> <span class="n">exts</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">exts</span><span class="p">.</span><span class="n">cy</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">text</span><span class="p">.</span><span class="n">Array</span><span class="p">(),</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span><span class="p">()</span> <span class="p">);</span>

    <span class="c1">// Debugging...check to see what's in HUD by pasting into someting like
</span>    <span class="c1">// PhotoShop afte the next line is executed...
</span>    <span class="c1">//m_HUD.CopyToClipboard( NULL );
</span>
    <span class="n">success</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////////////////////////////
//
</span><span class="n">bool</span> <span class="n">CCameraTrackingConduit</span><span class="o">::</span><span class="n">ExecConduit</span><span class="p">(</span><span class="n">CRhinoDisplayPipeline</span><span class="o">&amp;</span>    <span class="n">dp</span><span class="p">,</span>
                                         <span class="n">UINT</span>                      <span class="n">nChannel</span><span class="p">,</span>
                                         <span class="n">bool</span><span class="o">&amp;</span>                     <span class="n">bTerminate</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Is this is not viewport/pipeline we're currently tracking, then bail out now ...
</span>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">IsBound</span><span class="p">(</span> <span class="n">dp</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

  <span class="k">switch</span> <span class="p">(</span> <span class="n">nChannel</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// You might want to track the scene's current extents...or something similar...
</span>    <span class="k">case</span> <span class="n">CSupportChannels</span><span class="p">:</span><span class="o">:</span><span class="n">SC_CALCBOUNDINGBOX</span><span class="o">:</span>
    <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// The tracking is conveyed via a Heads Up Display that gets overlaid onto
</span>    <span class="c1">// the frame buffer. This channel either let's us replace the frame buffer
</span>    <span class="c1">// entirely, or simply modify it in some form...We're just going to build
</span>    <span class="c1">// up our HUD and then draw/overlay it on top of the current frame buffer
</span>    <span class="c1">// via transparent bitmap drawing...
</span>    <span class="k">case</span> <span class="n">CSupportChannels</span><span class="p">:</span><span class="o">:</span><span class="n">SC_POSTPROCESSFRAMEBUFFER</span><span class="o">:</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">BuildHUD</span><span class="p">()</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">dp</span><span class="p">.</span><span class="n">PushDepthTesting</span><span class="p">(</span> <span class="nb">false</span> <span class="p">);</span>
        <span class="n">dp</span><span class="p">.</span><span class="n">DrawBitmap</span><span class="p">(</span> <span class="n">m_HUD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_TransColor</span> <span class="p">);</span>
        <span class="n">dp</span><span class="p">.</span><span class="n">PopDepthTesting</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////////////////////////////
//
</span><span class="kt">void</span> <span class="n">CCameraTrackingConduit</span><span class="o">::</span><span class="n">NotifyConduit</span><span class="p">(</span><span class="n">EConduitNotifiers</span>       <span class="n">Notify</span><span class="p">,</span>
                                           <span class="n">CRhinoDisplayPipeline</span><span class="o">&amp;</span>  <span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// This conduit notifier only acts on existing pipelines, and assumes they're
</span>  <span class="c1">// created and exist...some notify events are based on pipelines coming online
</span>  <span class="c1">// and being deleted...so if we don't do the following, then we cannot assume
</span>  <span class="c1">// the current pipeline or any of its members are valid (without more checking).
</span>  <span class="c1">// Since we're only interested in a few events, we filter on them here...
</span>  <span class="c1">//
</span>  <span class="c1">// Note: If you want to process/handle other types of notification events, then
</span>  <span class="c1">//       make sure you add them to the condition below...
</span>  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">Notify</span> <span class="o">!=</span> <span class="n">CN_FRAMESIZECHANGED</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">Notify</span> <span class="o">!=</span> <span class="n">CN_PROJECTIONCHANGED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">Notify</span> <span class="o">!=</span> <span class="n">CN_PIPELINECLOSED</span><span class="p">)</span>    <span class="o">&amp;&amp;</span>
       <span class="p">(</span><span class="n">Notify</span> <span class="o">!=</span> <span class="n">CN_PIPELINEDELETED</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">CRhinoViewport</span><span class="o">&amp;</span>   <span class="n">View</span> <span class="o">=</span> <span class="n">dp</span><span class="p">.</span><span class="n">GetRhinoVP</span><span class="p">();</span> <span class="c1">// We might need specifics from each
</span>  <span class="k">const</span> <span class="n">ON_Viewport</span><span class="o">&amp;</span>      <span class="n">vp</span>   <span class="o">=</span> <span class="n">View</span><span class="p">.</span><span class="n">VP</span><span class="p">();</span>       <span class="c1">// one of these, so we assign them to
</span>                                                  <span class="c1">// their own variable for simplicity...
</span>
  <span class="c1">// Is this the viewport we're currently tracking? ...
</span>  <span class="k">if</span> <span class="p">(</span> <span class="n">IsBound</span><span class="p">(</span> <span class="n">dp</span> <span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">Notify</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Since our HUD's size mirrors the size of the view we're tracking, we need
</span>      <span class="c1">// adjust our HUD if/when the view's frame size changes.
</span>      <span class="k">case</span> <span class="n">CN_FRAMESIZECHANGED</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="n">CreateHUD</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">dp</span> <span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Something changed the tracked view's projection, camera, or frustum settings...so
</span>      <span class="c1">// update our tracking variables accordingly.
</span>      <span class="c1">// Note: This only occurs when the view is being manipulated and NOT because some piece
</span>      <span class="c1">//       of code somewhere changed a setting. This notification only occurs during frame
</span>      <span class="c1">//       updates.
</span>      <span class="k">case</span> <span class="n">CN_PROJECTIONCHANGED</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="n">m_CameraLocation</span>   <span class="o">=</span> <span class="n">vp</span><span class="p">.</span><span class="n">CameraLocation</span><span class="p">();</span>
        <span class="n">m_CameraDirection</span>  <span class="o">=</span> <span class="n">vp</span><span class="p">.</span><span class="n">CameraDirection</span><span class="p">();</span>
        <span class="n">m_CameraTarget</span>     <span class="o">=</span> <span class="n">vp</span><span class="p">.</span><span class="n">TargetPoint</span><span class="p">();</span>
        <span class="n">m_CameraNear</span>       <span class="o">=</span> <span class="n">vp</span><span class="p">.</span><span class="n">FrustumNear</span><span class="p">();</span>
        <span class="n">m_CameraFar</span>        <span class="o">=</span> <span class="n">vp</span><span class="p">.</span><span class="n">FrustumFar</span><span class="p">();</span>
        <span class="n">vp</span><span class="p">.</span><span class="n">GetCamera35mmLensLength</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">m_CameraLensLength</span> <span class="p">);</span>

        <span class="c1">// TODO: Assign more tracking variables here based on what you want to track...
</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Not sure what you might want to do here, but this notification happens at the
</span>      <span class="c1">// END of EVERY frame update...which tends to be a good place to put/do certain things...
</span>      <span class="c1">// Note: The pipeline is closed by the time you receive this event, so writing anything
</span>      <span class="c1">//       to the display at this point is out of the question...
</span>      <span class="k">case</span> <span class="n">CN_PIPELINECLOSED</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// The pipeline/view we're tracking just got deleted...so we need to
</span>      <span class="c1">// stop tracking it...
</span>      <span class="c1">// Note: This can happen either because the view was deleted, the file was closed,
</span>      <span class="c1">//       or the display mode was changed to one that uses a different type of pipeline.
</span>      <span class="c1">//       Since it's hard to distinguish between all of those, we'll just disable ourself
</span>      <span class="c1">//       and error on the side of being safe.
</span>      <span class="k">case</span> <span class="n">CN_PIPELINEDELETED</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="n">StopTracking</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>  
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////////////////////////////
//
</span><span class="kt">void</span> <span class="n">CCameraTrackingConduit</span><span class="o">::</span><span class="n">StartTracking</span><span class="p">(</span><span class="k">const</span> <span class="n">CRhinoView</span><span class="o">*</span> <span class="n">pView</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">pView</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="n">ON_Viewport</span><span class="o">&amp;</span>   <span class="n">vp</span> <span class="o">=</span> <span class="n">pView</span><span class="o">-&gt;</span><span class="n">Viewport</span><span class="p">().</span><span class="n">VP</span><span class="p">();</span>

    <span class="n">CreateHUD</span><span class="p">(</span> <span class="n">pView</span><span class="o">-&gt;</span><span class="n">DisplayPipeline</span><span class="p">()</span> <span class="p">);</span>

    <span class="n">Bind</span><span class="p">(</span> <span class="n">vp</span> <span class="p">);</span>
    <span class="n">Enable</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////////////////////////////////////////
//
</span><span class="kt">void</span> <span class="n">CCameraTrackingConduit</span><span class="o">::</span><span class="n">StopTracking</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">UnbindAll</span><span class="p">();</span>
  <span class="n">Disable</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#pragma region TestCameraTracker command
</span>
<span class="k">class</span> <span class="nc">CCommandTestCameraTracker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CRhinoCommand</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">CCommandTestCameraTracker</span><span class="p">()</span> <span class="p">{}</span>
	<span class="o">~</span><span class="n">CCommandTestCameraTracker</span><span class="p">()</span> <span class="p">{}</span>
	<span class="n">UUID</span> <span class="n">CommandUUID</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="c1">// {3D16E807-F816-4C86-92A2-C7B40C883E03}
</span>		<span class="k">static</span> <span class="k">const</span> <span class="n">GUID</span> <span class="n">TestCameraTrackerCommand_UUID</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mh">0x3D16E807</span><span class="p">,</span> <span class="mh">0xF816</span><span class="p">,</span> <span class="mh">0x4C86</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">}</span> <span class="p">};</span>
		<span class="k">return</span> <span class="n">TestCameraTrackerCommand_UUID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">const</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">EnglishCommandName</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">L"TestCameraTracker"</span><span class="p">;</span> <span class="p">}</span>
	<span class="n">CRhinoCommand</span><span class="o">::</span><span class="n">result</span> <span class="n">RunCommand</span><span class="p">(</span> <span class="k">const</span> <span class="n">CRhinoCommandContext</span><span class="o">&amp;</span> <span class="p">);</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">CCameraTrackingConduit</span>  <span class="n">m_Conduit</span><span class="p">;</span>

<span class="p">};</span>

<span class="c1">// The one and only CCommandTestCameraTracker object
</span><span class="k">static</span> <span class="k">class</span> <span class="nc">CCommandTestCameraTracker</span> <span class="n">theTestCameraTrackerCommand</span><span class="p">;</span>

<span class="n">CRhinoCommand</span><span class="o">::</span><span class="n">result</span> <span class="n">CCommandTestCameraTracker</span><span class="o">::</span><span class="n">RunCommand</span><span class="p">(</span> <span class="k">const</span> <span class="n">CRhinoCommandContext</span><span class="o">&amp;</span> <span class="n">context</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Are we already tracking a view? ...
</span>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">m_Conduit</span><span class="p">.</span><span class="n">IsEnabled</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// No, so start tracking the active viewport...
</span>    <span class="n">CRhinoView</span><span class="o">*</span> <span class="n">pActiveView</span> <span class="o">=</span> <span class="o">::</span><span class="n">RhinoApp</span><span class="p">().</span><span class="n">ActiveView</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">pActiveView</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">m_Conduit</span><span class="p">.</span><span class="n">StartTracking</span><span class="p">(</span> <span class="n">pActiveView</span> <span class="p">);</span> <span class="c1">// Only track the camera of a single, specific view...
</span>    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="c1">// We're already tracking something so stop...this makes the command act as a toggle.
</span>    <span class="n">m_Conduit</span><span class="p">.</span><span class="n">StopTracking</span><span class="p">();</span>

  <span class="c1">// Force redraw of all views...
</span>  <span class="n">context</span><span class="p">.</span><span class="n">m_doc</span><span class="p">.</span><span class="n">Regen</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">CRhinoCommand</span><span class="o">::</span><span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#pragma endregion
</span>
<span class="c1">//
// END TestCameraTracker command
//
////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////
</span></code></pre>
</div>

        </article>

      <!--</div>-->

    </div>
</div>
</div>

        <!--/div-->
      </div>

      <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">

      
        <div class="row">
          <div class="col-md-4">
            <p class="text">Author: <a href="mailto:dale@mcneel.com">dale@mcneel.com</a></p>
          </div>
          <div class="col-md-4 text-center">
            
            
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <a href="https://github.com/mcneel/developer-rhino3d-com/blob/gh-pages/_guide_topics/cpp/tracking_camera_changes_with_conduits.md" target="_blank">Edit page on GitHub</a>
          </div>
            <div class="col-md-4">
              <span class="pull-right">
                <span class="glyphicon glyphicon-cog"></span>&nbsp;<a href="/developer-rhino3d-com-branches/admin">Admin</a>
              </span>
            </div>
        </div>

        <div class="row text-center">
          © 1997 - 2016 Robert McNeel &amp; Associates
        </div>

      

    </div>

  </div>

  <script>
    if (navigator.appVersion.indexOf("Win")!=-1)
    {
      var body = document.getElementsByTagName("body");
      body[0].style.fontWeight = '400';
    }
  </script>

</footer>

    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <!-- MathJax -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script type="text/javascript">
    $('body').scrollspy({
        target: '.bs-docs-sidebar',
        offset: 110
    });
    </script>
  </body>

</html>
